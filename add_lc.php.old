<?php
include "cn.php";
include "funcoes.php";

if ( isset( $_POST['id_oc'] ) ) {
	$sql="select * from tab_listacompraitem where id_lc=" .  $_POST['id_lc'];

	if ($rs=$cn->query($sql)) {
		while( $row=$rs->fetch_assoc() ) {	
			
			if( $row['id_produto']<0 ) {
			
				$sql="insert into tab_ordemcompraitem (id_oc,id_produto,qtdvol,vol1,vol2,tipo,custo,obs) values (" . $_POST['id_oc'] . "," . $row['id_produto'] . ",0,0,0,'',0,'" . $row['obs'] . "')";
				$cn->query($sql);					
			
			} else {
				$sql="select * from tab_estent inner join tab_produto on tab_produto.id_produto=tab_estent.id_produto where tab_estent.id_produto=" . $row['id_produto'] . " order by tab_estent.data desc limit 1";
				
				if ($rs2=$cn->query($sql)) {
					if( $row2=$rs2->fetch_assoc() ) {				
						
						$sql="insert into tab_ordemcompraitem (id_oc,id_produto,qtdvol,vol1,vol2,tipo,custo,obs) values (" . $_POST['id_oc'] . "," . $row['id_produto'] . "," . number_format($row2['qtdvol'],3,".",",") . ",0,0,'" . $row2['tipo'] . "',0,'')";
						$cn->query($sql);					

					}
				}
			}
		}
		return;
	}
}
?>
<h1>:: Lista de Compra</h1>
<?php
$sql="select * from tab_listacompra";

if ($rs=$cn->query($sql)) {
	if( $row=$rs->fetch_assoc() ) {
		echo "<table><tr><th align='left'>Lista de Compra</th><th></th></tr>";

		do {
			echo "<tr><td>" . $row['descricao'] . "</td><td><input type='button' value='Add' onclick=\"AddLC(" . $_POST['id'] . "," . $row['id_lc'] . ");\" /></td></tr>";
		} while( $row=$rs->fetch_assoc() );
		
		echo "</table>";

	} else {
		echo "<tr><td colspan='6'>Não há lista(s) de Compra(s) cadastrada.</td></tr>";
	}
}

$cn->close();
?>