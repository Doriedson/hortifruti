<?php
include "cn.php";

if( !isset($_SESSION) ){
//	include "logout.php";    
	session_start();
}
if (isset($_POST['id_oc']) ) {

	$sql="insert into tab_estent (id_entidade, id_produto, qtdvol, vol, data, custo, tipo) select " . $_SESSION['id'] . ",oci.id_produto,oci.qtdvol,oci.vol1,oc.data,oci.custo,oci.tipo from tab_ordemcompraitem oci inner join tab_ordemcompra oc on oc.id_oc=oci.id_oc where oci.id_oc=" . $_POST['id_oc'] . " and oci.id_produto>0";
	$cn->query($sql);

	$sql="insert into tab_tmppreco (id_produto, custo) select id_produto, custo/qtdvol from tab_ordemcompraitem where id_oc=" . $_POST['id_oc'] . " and id_produto>0";
	$cn->query($sql);

	$sql="insert into tab_tmppreco (id_produto, custo) select p.id_produto,c.custo/c.qtdvol*p.sub_qtd from tab_ordemcompraitem c inner join tab_produto p on p.sub_produto=c.id_produto where c.id_oc=" . $_POST['id_oc'] . " and c.id_produto>0";
	$cn->query($sql);
	
	$sql="insert into tab_ctspag (id_catctspag, id_entidade, datacad, descricao, vencimento, valor, datapago, valorpago) select -oci.id_produto," . $_SESSION['id'] . ",oc.data,concat(replace(oci.vol1,'.',','),' ',oci.obs),oc.data,oci.vol1*oci.custo,oc.data,oci.vol1*oci.custo from tab_ordemcompraitem oci inner join tab_ordemcompra oc on oc.id_oc=oci.id_oc where oci.id_oc=" . $_POST['id_oc'] . " and oci.id_produto<0";
	$cn->query($sql);

	$sql="delete from tab_ordemcompraitem where id_oc=" . $_POST['id_oc'];
	$cn->query($sql);

	$sql="delete from tab_ordemcompra where id_oc=" . $_POST['id_oc'];
	$cn->query($sql);

}

$cn->close();
?>
