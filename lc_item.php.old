<?php
if( !isset($_SESSION) ) {
	session_start();
}

include "cn.php";

if ( isset( $_POST['del'] ) ) {
	$sql="delete from tab_listacompraitem where id_lcitem=" . $_POST['del'];
	$rs=$cn->query($sql);
}

if ( isset( $_POST['id_produto'] ) ) {

	$sql="select tab_produto.* from tab_produto left join tab_codbar on tab_codbar.id_produto=tab_produto.id_produto where tab_produto.id_produto=" . $_POST['id_produto'] . " or tab_codbar.codbar=" . $_POST['id_produto'];
	
	if ( $rs=$cn->query($sql) ) {
		if ($row=$rs->fetch_assoc()) {
			
			$tipo=$row['tipo'];
			$qtd=0;
			
			$sql="select * from tab_estent where id_produto=" . $row['id_produto'] . " order by data desc limit 1;";
		
			if ( $rs=$cn->query($sql) ) {
				if ($row=$rs->fetch_assoc()) {
					$qtd=$row['qtdvol'];
				}
			}
			
			$sql="insert into tab_listacompraitem (id_lc,id_produto,obs) values (" . $_POST['id'] . "," . $_POST['id_produto'] . ",'')";
			$rs=$cn->query($sql);

		} else {
			echo "<!--erro-->";
			$cn->close();
			return;
		}
	}
}

if ( isset( $_POST['cat'] ) ) {
	$sql="insert into tab_listacompraitem (id_lc,id_produto,obs) values (" . $_POST['id'] . ",-" . $_POST['cat'] . ",'" . strtoupper($_POST['produto']) . "')";
	$cn->query($sql);
}

$sql="select * from tab_listacompra where id_lc=" . $_POST['id'];

if ( $rs=$cn->query($sql) ) {
	$row=$rs->fetch_assoc();

	?>
	<h1>:: Lista de Compra - Itens (<input type="button" value="LCs" onclick="$('#content').load('lista_compra.php');" />)</h1>

	<p>Lista: <?php echo $row['descricao']; ?><br />
	<?php
	
	$sql="select * from tab_catctspag order by catctspag";

	if ( $rs=$cn->query($sql) ) {
		if ($row=$rs->fetch_assoc()) {

			echo "Adicionar Insumo:<form method='post' onsubmit='return InsumoLC();' ><input type='hidden' id='id' value='" . $_POST['id'] . "' /><select id='cat' autofocus>";
		
			do {
				echo "<option value='" . $row['id_catctspag'] . "'>" . $row['catctspag'] . "</option>";
			} while ($row=$rs->fetch_assoc());
			
			echo "</select><br />";
			echo "<input type='text' id='produto' size='40' maxlength='100' required placeholder='Descrição' pattern='[A-Z a-z0-9]+' />";
			echo " <input type='submit' value='Adicionar' /></form><br />";
		} else {
			echo "<p>Para adicionar insumos, cadastre uma categoria em Despesas.";
		}
	}
	
	echo "Adicionar Produto:<br /><form method='post' onsubmit='return ProdutoLC();' ><input type='hidden' id='id' value='" . $_POST['id'] . "' />";
	echo "<input type='text' id='id_produto' size='13' maxlength='13' required placeholder='Código Produto' pattern='\d+' />";
	echo " <input type='submit' value='Adicionar' /></form><br />";
	
	$sql="select * from tab_listacompraitem left join tab_produto on tab_produto.id_produto=tab_listacompraitem.id_produto left join tab_catctspag on tab_catctspag.id_catctspag=-tab_listacompraitem.id_produto where tab_listacompraitem.id_lc=" . $_POST['id'] . " order by tab_listacompraitem.id_lcitem desc";

	if ( $rs=$cn->query($sql) ) {
		if ( $row=$rs->fetch_assoc() ) {
			echo "<table><tr><th>Produto</th></tr>";
			
			do {
				if( is_null( $row['produto'] ) ) {
					echo "<tr><td>" . $row['obs'] . "</td>";
				} else {
					echo "<tr><td>" . $row['produto'] . "</td>";
				}

				echo "<td><input type='button' onclick='DelItemLC(" . $_POST['id'] . "," . $row['id_lcitem'] . ")' value='x' /></td>";
				echo "</tr>";

			} while ($row=$rs->fetch_assoc());
			
			echo "</table>";
		} else {
			echo "Não há itens na Lista de Compra.";
		}
	}
}
$cn->close();
?>
